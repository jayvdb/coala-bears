sudo: false

dist: trusty

matrix:
  include:
    - language: node_js
      node_js: 4
    - language: ruby
      rvm: 2
    - language: r
    - language: go
      go: 1.4
    - language: go
      go: 1.5
    - language: go
      go: 1.6
    - language: go
      go: 1.7
    - language: haskell
      dist: precise
      addons:
        apt:
          sources: deadsnakes
          packages: python3.4
      ghc: 7.8

cache:
  pip: true
  directories:
    # Installed language package caches
    - ~/.cabal
    - ~/R/Library
    - ~/.julia
    - $TRAVIS_BUILD_DIR/node_modules
    - $TRAVIS_BUILD_DIR/.bundle
    - $TRAVIS_BUILD_DIR/vendor
    # coala managed data
    - ~/nltk_data
    - ~/.local/share/coala-bears
    # .deb cache
    - ~/.apt-cache
    # Installed linters
    - ~/infer-linux64-v0.7.0
    - ~/pmd-bin-5.4.1
    - ~/bakalint-0.4.0
    - ~/dart-sdk/bin
    - ~/.local/tailor/

env:
  global:
    - CIRCLE_NODE_INDEX=-1  # Avoid accidentially being a CircleCI worker
    - USE_PPAS="marutter/rdev staticfloat/juliareleases ondrej/golang"
    - R_LIB_USER=~/R/Library
    - LINTR_COMMENT_BOT=false
    - PATH="$HOME/bin:$PATH:$TRAVIS_BUILD_DIR/node_modules/.bin:$TRAVIS_BUILD_DIR/vendor/bin:$HOME/dart-sdk/bin:$HOME/.cabal/bin:$HOME/infer-linux64-v0.7.0/infer/bin:$HOME/pmd-bin-5.4.1/bin:$HOME/bakalint-0.4.0:$HOME/.local/tailor/tailor-latest/bin"

before_install:
  - >
    if [[ -z "$TRAVIS_PYTHON_VERSION" ]]; then
      mkdir -p $HOME/bin
      echo pip3.4 is $(which pip3.4)
      echo python3.4 is $(which pip3.4)
      if [[ -n "$(which pip3.4)" ]]; then ln -sf $(which pip3.4) $HOME/bin/pip3; fi
      if [[ -n "$(which python3.4)" ]]; then ln -sf $(which python3.4) $HOME/bin/python3; fi
      echo pip3.5 is $(which pip3.5)
      echo python3.5 is $(which pip3.5)
      if [[ -n "$(which pip3.5)" ]]; then ln -sf $(which pip3.5) $HOME/bin/pip3; fi
      if [[ -n "$(which python3.5)" ]]; then ln -sf $(which python3.5) $HOME/bin/python3; fi
      echo pip3 is $(which pip3)
      echo python3 is $(which pip3)
      if [[ -n "$(which pip3)" ]]; then ln -sf $(which pip3) $HOME/bin/pip; fi
      if [[ -n "$(which python3)" ]]; then ln -sf $(which python3) $HOME/bin/python; fi
      pip --version
      python --version
    fi

  # Remove Ruby directive from Gemfile as this image has 2.2.5
  - sed -i '/^ruby/d' Gemfile
  - mkdir -p ~/.apt-cache
  - if [[ "$BEARS" == "all" ]]; then nvm install 4; nvm use 4; bash .ci/deps.sh; fi
  - if [[ "$BEARS" == "all" ]]; then bash .ci/deps.shellcheck.sh; fi
  # https://github.com/coala/coala/issues/3183
  - cp requirements.txt requirements.orig
  - cat test-requirements.txt docs-requirements.txt >> requirements.txt
  - >
    if [[ "$BEARS" == "all" || "$BEARS" == "python" ]]; then
      cat bear-requirements.txt >> requirements.txt;
    else
      echo 'pyyaml' > bear-requirements.txt;
    fi
  - sed -i '/^-r/d' requirements.txt
  # On unsupported versions, coala will be installed in the `script` block
  - >
    if [[ "$UNSUPPORTED" == true ]]; then
      sed -e '/^coala/d' requirements.txt > requirements.new
      mv requirements.new requirements.txt
      BEARS=none
    fi
  - if [[ -z "$TRAVIS_PYTHON_VERSION" ]]; then pip install -r requirements.txt; fi

before_script:
  - mv requirements.orig requirements.txt
  # nltk 3.2.2 dropped support for Python 3.3
  - >
    if [[ "$BEARS" == "all" || "$BEARS" == "python" ]]; then
      python -m nltk.downloader punkt maxent_treebank_pos_tagger averaged_perceptron_tagger
    fi
  # Only keep non-Python bears on Python 3.4
  - bash .ci/bears.prune.sh
  # Delete tests for removed bears
  - bash .ci/tests.prune.sh

script:
  - >
    if [[ "$UNSUPPORTED" == true ]]; then
      set -e
      python setup.py install | tee setup.err
      grep -q 'coala supports only python 3.4 or later' setup.err
      if grep -q 'Traceback (most recent call last)' setup.err; then
        false
      fi
    fi
  - if [[ "$UNSUPPORTED" == true ]]; then exit; fi
  - coverage run setup.py bdist_wheel
  - >
    if [[ "$BEARS" == "all" || "$BEARS" == "python" ]]; then
      pip install $(ls ./dist/*.whl)"[alldeps]"
    else
      pip install $(ls ./dist/*.whl)
    fi
  - bash .ci/tests.sh
  # Ensure bear requirements are in sync with the bear PipRequirement
  - .ci/generate_bear_requirements.py
  - >
    if [[ "$BEARS" == "all" || "$BEARS" == "python" ]]; then
      git diff --exit-code bear-requirements.txt
    fi
  - >
    if [[ "$BEARS" == "all" || "$BEARS" == "gem" ]]; then
      git diff --exit-code Gemfile
    fi
  - >
    if [[ "$BEARS" == "all" || "$BEARS" == "npm" ]]; then
      git diff --exit-code package.json
    fi
  # https://github.com/coala/coala-bears/issues/1037
  - >
    if [[ "$TRAVIS_PULL_REQUEST" != "false" ]]; then
      sed -e '/bears = GitCommitBear/d' .coafile > .coafile.new
      mv .coafile.new .coafile
    fi
  - coala --non-interactive
  - bash .ci/deploy.coverage.sh
  - rm -rf docs/API && make -C docs clean
  - python setup.py docs

notifications:
  email: false

branches:
  exclude:
    - /^sils\//
