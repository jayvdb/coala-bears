sudo: false

.disable_global: &disable_global
  addons: false
  cache: pip
  before_install: false
  install: false
  before_script: false
  script: false
  after_success: false
  after_failure: false
  before_deploy: false
  deploy: false

stages:
  - test-travis-community-langs
  - test-apt
  - test-extra-langs
  - test-python
  - test-main-langs-primary-version
  - test-main-langs-other-versions
  - test-travis-other-langs-primary-version
  # test-travis-other-langs-other-versions
  - haskell
  - opam
  - moban
  - name: sentinel
    if: branch != master OR type = pull_request
  - name: unsupported
    if: branch = master AND type = push

.check_moban: &check_moban
  <<: *disable_global
  language: python
  python: 3.6
  stage: moban
  install: pip install moban
  script: .ci/check_moban.sh
  if: branch != master OR type = pull_request

jobs:
  include:
    - stage: sentinel
      # All other jobs will be cancelled if the sentinel job fails
      <<: *disable_global
      language: python
      python: 3.6
      install: pip install -r requirements.txt ".[alldeps]"
      script: coala --non-interactive -V

    - python: 2.7
      language: python
      stage: unsupported
      env: PIP_NO_COMPILE=1
      addons: false
      before_install: true
      install: pip install 3to2
      before_script: true
      script: .ci/check_unsupported.sh
    - python: 3.3
      language: python
      stage: unsupported
      env: PIP_NO_COMPILE=1
      addons: false
      before_install: true
      install: true
      before_script: true
      script: .ci/check_unsupported.sh

    - python: 3.6
      language: python
      stage: moban
      addons: false
      cache: pip
      before_install: false
      install: pip install moban
      before_script: false
      script: .ci/check_moban.sh
      after_success: false
      after_failure: false
      if: branch = master AND type = push

    - stage: test-python

      language: python
      python: 3.6
      addons:
        apt:
          packages: clang-3.4
    - language: python
      python: 3.5
      addons:
        apt:
          packages: clang-3.4

    - stage: test-main-langs-primary-version

      language: node_js
      node_js: 5

    - language: ruby
      rvm: 2.4

    - language: go
      go: 1.11
      install: true

    - stage: test-main-langs-other-versions

      language: node_js
      node_js: 10
    - language: node_js
      node_js: 9
    - language: node_js
      node_js: 8
    - language: node_js
      node_js: 7
    - language: node_js
      node_js: 6

    - language: ruby
      rvm: 2.3
    - language: ruby
      rvm: 2.2
    - language: ruby
      rvm: 2.1

    - language: go
      go: '1.10'
      install: true

    - stage: test-travis-other-langs-primary-version

      language: php
      php: 7.2

    - language: java
      jdk: oraclejdk8

    - language: perl

    # stage: test-travis-other-langs-other-versions

    - language: php
      php: 5.5

    # Fails on 'pear'
    # language: php
    # php: hhvm-3.18

    # Tailor depends on java 8
    # language: java
    # jdk: openjdk7
    # language: java
    # jdk: openjdk6

    # Travis community supported languages

    # failing, reason unknown
    # language: dart
    - stage: test-travis-community-langs
      language: elm
      install: true  # bypass install of all package.json
    - language: julia
      # default language is 0.6.4, and has problems with pre-installed Lint.jl
      julia: 1.1
    - language: julia
      julia: 1.0.3

    - language: r
      # default version is 3.6.0, and it doesnt do DESCRIPTION
      r: oldrel
    - language: r
      r: release
    - language: r
      r: devel

    # coala hacks for extra languages
    - stage: test-extra-langs

      language: minimal
      env: BEARS=lua
      addons:
        apt:
          packages:
            - luarocks

    - stage: opam
      language: generic
      env: BEARS=opam
      addons:
        apt:
          sources:
            - avsm
          packages:
            - camlp4-extra
            - ocaml
            - opam

    - stage: haskell
      language: haskell
      ghc: 8.0.2
      dist: precise
      addons:
        apt:
          sources:
            - deadsnakes
            - hvr-ghc
          packages:
            - cabal-install-1.24
            - ghc-8.0.2
            - happy-1.19.3
            - python3.4

    # language: haskell
    # ghc: "7.10"
    # language: haskell
    # ghc: 7.8
    # language: haskell
    # ghc: 7.6
    - language: haskell
      ghc: 8.0.2
    - language: haskell
      ghc: 8.4.1

    # BEARS=apt_get rather than 'apt' to avoid invoking .deps.apt.sh
    # which is the old circle init
    - stage: test-apt
      language: generic
      env: DIST=precise BEARS=apt_get
      dist: precise
      addons:
        apt:
          sources:
            - deadsnakes
            - hvr-ghc
          packages:
            # These do not work on precise now
            # cabal-install-1.24
            # ghc-8.0.2
            # happy-1.19.3
            - chktex
            - cppcheck
            - flawfinder
            - indent
            - libperl-critic-perl
            - libxml2-utils
            - mono-mcs
            - php5-cli
            # php-codesniffer  # linter error?
            - python3
            # pyenv
            - verilator

    - language: generic
      env: DIST=trusty BEARS=apt_get
      dist: trusty
      addons:
        apt:
          packages:
            - chktex
            - cppcheck
            - flawfinder
            - indent
            - libperl-critic-perl
            - libxml2-utils
            - mono-mcs
            - php5-cli
            - php-codesniffer
            # pyenv
            - verilator

    - language: generic
      env: DIST=xenial BEARS=apt_get
      dist: xenial
      sudo: required
      addons:
        - *all_apt

    - *check_moban
  allow_failures:
    - *check_moban

dist: trusty

.apt_sources: &apt_sources
  - ubuntu-toolchain-r-test
  # avsm  # OPAM stable
  - hvr-ghc  # Haskell
  - sourceline:  # R
      deb https://cloud.r-project.org/bin/linux/ubuntu trusty-cran35/
    key_url:
      https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x51716619E084DAB9
  - sourceline:  # Julia
      deb http://ppa.launchpad.net/staticfloat/juliareleases/ubuntu trusty main
    key_url:
      https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xCF979FFA3D3D3ACC
  - sourceline:  # astyle
      deb http://ppa.launchpad.net/cs50/ppa/ubuntu trusty main
    key_url:
      https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x5BDA2E974A0E822C

all_apt: &all_apt
  apt:
    sources: *apt_sources
    packages:
      - aspcud
      - astyle
      - cabal-install-1.24
      - chktex
      - clang-3.4
      - cppcheck
      - devscripts
      - flawfinder
      - gfortran
      - ghc
      - happy
      - indent
      - julia
      - libarpack2
      - libblas-dev
      - libcolamd2.8.0
      - libfftw3-3
      - liblapack-dev
      - libopenblas-base
      - libpaper-utils
      - libperl-critic-perl
      - libumfpack5.6.2
      - libxml2-utils
      - luarocks
      - mercurial
      # menhir
      - mono-mcs
      # ocaml
      # opam
      - php-codesniffer
      - python3
      - pyenv
      - r-base
      - verilator

cache:
  pip: true
  directories:
    - docs/_build
    # Installed language package caches
    - ~/.cabal
    - ~/.ghc
    - ~/.ghc-mod
    - ~/R/Library
    - ~/.julia
    - ~/.luarocks
    - $TRAVIS_BUILD_DIR/node_modules
    - $TRAVIS_BUILD_DIR/.bundle
    - $TRAVIS_BUILD_DIR/vendor
    # coala managed data
    - ~/nltk_data
    # Installed linters
    - ~/infer-linux64-v$INFER_VERSION
    - ~/.local/

env:
  global:
    - TERM=dumb
    - R_LIB_USER=~/R/Library
    - LINTR_COMMENT_BOT=false
    - CABAL_VERSION=1.24
    - INFER_VERSION=0.7.0
    - PATH="$HOME/.local/bin:/opt/cabal/$CABAL_VERSION/bin:$PATH:$TRAVIS_BUILD_DIR/node_modules/.bin:$TRAVIS_BUILD_DIR/vendor/bin:$HOME/.cabal/bin:$HOME/infer-linux64-v$INFER_VERSION/infer/bin:$HOME/.local/tailor/tailor-latest/bin:$HOME/.luarocks/bin"

before_install:
  - printenv
  # echo $TRAVIS_LANGUAGE
  - if [ -f .ci/deps.$TRAVIS_LANGUAGE.sh ]; then
      bash -e -x .ci/deps.$TRAVIS_LANGUAGE.sh;
    fi

  - python --version
  # ~/bin is uncached; ~/local/bin is cached; we dont want python/pip in latter
  - rm -f ~/.local/bin/python* ~/.local/bin/pip*
  - mkdir -p ~/bin ~/.local/bin
  - source .ci/deps.pyenv.sh
  - pyenv versions
  - source .ci/deps.python36.sh
  # node-gpy needs py27
  - if [ "$TRAVIS_LANGUAGE" = "node_js" ]; then pyenv global 2.7; hash -r; fi
  - pyenv versions
  - python --version
  # if [[ -z "$TRAVIS_PYTHON_VERSION" ]]; then .ci/ensure_python3.sh; fi

  # Install latest stable version of Go using gimme
  # gimme 1.11.5 > setup_go_root.sh
  # source setup_go_root.sh
  # nvm install 6.10.2
  # Remove Ruby directive from Gemfile as this image has 2.2.5
  - sed -i '/^ruby/d' Gemfile

  # Used by go, to do nothing
  - if [ -f .ci/$TRAVIS_LANGUAGE.GNUMakefile ]; then
      ln -s .ci/$TRAVIS_LANGUAGE.GNUMakefile ./GNUMakefile;
    fi
  # https://github.com/coala/coala/issues/3183
  - cp requirements.txt requirements.orig
  - printf '%s\n%s\n%s\n%s\n%s\n%s\n%s\n'
           "tox-travis" "tox-backticks" "tox-pyenv" "tox-venv"
           "$(cat test-requirements.txt)"
           "$(grep -v '^-r' docs-requirements.txt)"
           "$(cat bear-requirements.txt requirements.txt)"
           > requirements.txt
  - ls -al requirements.txt GNUMakefile || true

before_script:
  - mv requirements.orig requirements.txt

script:
  # python setup.py bdist_wheel
  # pip install $(ls ./dist/*.whl)"[alldeps]"
  # Ensure bear requirements are in sync with the bear PipRequirement
  # .ci/generate_bear_metadata.py --check --update
  # coala --non-interactive
  - if [ -z "$TRAVIS_PYTHON_VERSION" ]; then
      pyenv global $(pyenv versions | fgrep '3.6' --max-count 1);
      hash -r;
    fi
  - if [ "$TRAVIS_LANGUAGE" != "python" ]; then
      python -m pip install --user tox-travis tox-backticks tox-pyenv tox-venv;
    fi
  - python -m tox
  # codecov
  # python setup.py docs

notifications:
  email: false

branches:
  exclude:
    - /^sils\//
