sudo: false
python: 3.6

.disable_global: &disable_global
  addons: false
  cache: pip
  python: false
  before_install: false
  install: false
  before_script: false
  script: false
  after_success: false
  after_failure: false
  before_deploy: false
  deploy: false

stages:
  - test-first
  - test-python
  - test-languages
  - test-other-versions
  - test-travis-community-langs
  - test-manual-langs
  - test-apt
  - test-failing
  - moban
  - name: sentinel
    if: branch != master OR type = pull_request
  - name: test-master
    if: branch = master AND type = push
  - name: unsupported
    if: branch = master AND type = push

.check_moban: &check_moban
  <<: *disable_global
  language: python
  python: 3.6
  stage: moban
  install: pip install moban
  script: .ci/check_moban.sh
  if: branch != master OR type = pull_request

jobs:
  include:
    - stage: sentinel
      # All other jobs will be cancelled if the sentinel job fails
      <<: *disable_global
      language: python
      python: 3.6
      install: pip install -r requirements.txt ".[alldeps]"
      script: coala --non-interactive -V

    - python: 2.7
      language: python
      stage: unsupported
      env: PIP_NO_COMPILE=1
      addons: false
      before_install: true
      install: pip install 3to2
      before_script: true
      script: .ci/check_unsupported.sh
    - python: 3.3
      language: python
      stage: unsupported
      env: PIP_NO_COMPILE=1
      addons: false
      before_install: true
      install: true
      before_script: true
      script: .ci/check_unsupported.sh

    - python: 3.6
      language: python
      stage: moban
      addons: false
      cache: pip
      before_install: false
      install: pip install moban
      before_script: false
      script: .ci/check_moban.sh
      after_success: false
      after_failure: false
      if: branch = master AND type = push

    # Example
    - stage: test-disabled
      language: go
      env: BEARS=disabled BEAR_LIST="textlint tslint write-good"
      before_install:
        - choco list --local-only
        - which python
        - python --version
        - node --version || true
        - which go || true
        # /c/Users/travis/.gimme/versions/go1.11.11.windows.amd64/bin/g
        - go version || true
        - rust --version || true
        # choco update git.install
        - powershell -c "Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope LocalMachine"
        - uname -a
        - where.exe uname
        - exit 1

    - stage: test-disabled
      language: node_js
      node_js: lts
      env: BEARS=disabled BEAR_LIST="textlint tslint write-good"
      before_install:
        - choco list --local-only
        - which python
        - python --version
        - which node
        # C:\ProgramData\nvs\node\10.16.0\x64
        - node --version || true
        - which go || true
        - go version || true
        - ls ${TRAVIS_HOME}/.cargo/bin || true
        - which rustc
        - rustc --version || true
        # choco update git.install
        - powershell -c "Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope LocalMachine"
        - uname -a
        - where.exe uname
        - exit 1

    - stage: test-disabled
      language: rust
      env: BEARS=disabled BEAR_LIST="textlint tslint write-good"
      before_install:
        - choco list --local-only
        - which python
        - python --version
        - node --version || true
        - which go || true
        - go version || true
        - rust --version || true
        # choco update git.install
        - powershell -c "Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope LocalMachine"
        - uname -a
        - where.exe uname
        - exit 1

    # try travis_install_jdk travis_setup_java

    # go C:\ProgramData\GooGet

    - stage: test-first
      os: windows
      language: bash
      python: 3.6.8
      env:
        BEAR_LIST="astyle cppcheck xmllint"
        TOX_TEST_SELECTORS=pip-noreqs-npm-gem-go-perl-php-java8-adhoc
      cache:
        directories:
          - /C/nuget_http_cache
          - /C/choco_cache
          - /C/pip_cache
      before_install:
        - bash --version
        - powershell -c "$PSVersionTable"
        - powershell -command 'Set-MpPreference -DisableRealtimeMonitoring $true'
        - powershell -command 'Set-MpPreference -DisableArchiveScanning $true'
        - powershell -command 'Set-MpPreference -DisableBehaviorMonitoring $true'

        - export NUGET_HTTP_CACHE_PATH=/C/nuget_http_cache
        - export CHOCO_CACHE_DIR=/C/choco_cache
        - export PIP_CACHE_DIR=/C/pip_cache

        - printenv

        - cp .ci/choco.config $ChocolateyInstall/config/chocolatey.config
        - powershell -c "Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope LocalMachine"

        - python .ci/store_env_in_registry.py

        - source .ci/refreshenv.sh

        - refreshenv

        - choco list --local-only

        # TODO: Add support for disabling pre-installed vctools which is
        # disabled in choco_requirements.  Uninstalling vctools fails

        # Avoid tools finding and using Visual Studio
        - VSLOC="$(vswhere -all -legacy -format value -property installationPath || true)"
        - if [ "${VSLOC}" ]; then rm -rf "${VSLOC}"; fi
        - rm -rf
            "/c/Program Files (x86)/MSBuild"
            /c/Windows/Microsoft.NET/Framework/v4.0.30319/msbuild.exe
        - ls "/C/Windows/Microsoft.NET/"
           "/c/Program Files (x86)/Microsoft.NET/"
           "/c/Program Files (x86)/Microsoft Visual Studio/"
           || true
        - VSLOC="$(vswhere -all -legacy -format value -property installationPath || true)"
        - echo VSLOC2="${VSLOC}"
        - ls "/c/Program Files (x86)/"

        - which msbuild || true

      install:
        # TODO: move into post-install
        # These are empty at this stage, and probably not used at all
        # but pip complains about them not being in the PATH, which might
        # be for --user support
        - ls /C/Users/travis/AppData/Roaming/ || true
        - ls /C/Users/travis/AppData/Roaming/Python/ || true
        - ls /C/Users/travis/AppData/Roaming/Python/Python36/ || true
        - ls /C/Users/travis/AppData/Roaming/Python/Python36/Scripts/ || true
        - PYTHON_PATH=/C/Users/travis/AppData/Roaming/Python/Python36
        - export PATH="$PYTHON_PATH:$PYTHON_PATH/Scripts:$PATH"
        - echo $PATH
        - python .ci/store_env_in_registry.py

        - powershell -c ". .ci/Fudge.ps1 install"

        - refreshenv
        - taskkill -IM "gpg-agent.exe" || true

        - echo $PERL5LIB
        - which perl
        - perl --version || true
        - which ppm || true
        - ppm --version

      before_script:
        - python --version
        - export TOXENV=py36-${TOX_TEST_SELECTORS}-${TOX_FEATURES}-win
        - "sed -i 's/^envlist.*$/envlist: '$TOXENV/ tox.ini"

      script:
        - echo $PATH
        - python -m tox --sitepackages -vvv

    - stage: test-python

      language: python
      python: 3.6
      addons:
        apt:
          packages: clang-3.4
    - language: python
      python: 3.5
      addons:
        apt:
          packages: clang-3.4
    - language: python
      python: 3.4
      addons:
        apt:
          packages: clang-3.4

    - stage: test-languages

      language: node_js
      node_js: 10

    - language: ruby
      rvm: 2.4

    - language: go
      go: 1.11
      install: true

    - language: php
      php: 7.2

    - language: java
      jdk: oraclejdk8

    - language: perl
      perl: 5.14

    - language: scala
      scala: 2.11

    - stage: test-master

      # This is under other languages, as the only bear is tailor
      # which is java, already covered above.  Listed first to schedule
      # it early onto osx, as they take a while to spin up
      language: objective_c
      os: osx
      dist: false

    - stage: test-other-versions

      language: node_js
      node_js: 9
    - language: node_js
      node_js: 8
    - language: node_js
      node_js: 7
    - language: node_js
      node_js: 6

    - language: ruby
      rvm: 2.5
      env: DISABLE_BEARS=csvlint
    - language: ruby
      rvm: 2.3
    - language: ruby
      rvm: 2.2
    - language: ruby
      rvm: 2.1

    - language: go
      go: '1.10'
      install: true

    - language: php
      php: hhvm-3.18
    - language: php
      php: 5.5

    - language: scala
      jdk: oraclejdk8
      scala: 2.12.2

    - language: java
      jdk: oraclejdk11
      env: DISABLE_BEARS="languagetool tailor"
    # oraclejdk10 is EOL
    - language: java
      jdk: oraclejdk9
      env: DISABLE_BEARS="languagetool tailor"

    - language: java
      jdk: openjdk11
      env: DISABLE_BEARS="languagetool tailor"
    - language: java
      jdk: openjdk10
      env: DISABLE_BEARS="languagetool tailor"
    - language: java
      jdk: openjdk9
      env: DISABLE_BEARS="languagetool tailor"
    - language: java
      jdk: openjdk7
      env: DISABLE_BEARS=tailor

    # Travis community supported languages

    - stage: test-travis-community-langs
      language: csharp
      mono: 5.20.1

    - language: dart
      dart: 1.15.0

    - language: dart
      dart: 1.14.2

    - stage: test-failing
      language: elm
      elm: 0.19.0
      install: true  # bypass install of all package.json

    - stage: test-failing
      language: elm
      elm: 0.18.0
      install: true  # bypass install of all package.json

    - stage: test-travis-community-langs
      language: julia
      # default language is 0.6.4, and has problems with pre-installed Lint.jl
      julia: 1.1
      env: JL_PKG=CoalaBears
      # install not provided https://github.com/travis-ci/travis-build/pull/1571
      install:
        - julia --color=yes .ci/deps.julia.jl
        # Verify compilation works
        - julia -e 'import Lint.lintfile'

    - language: julia
      julia: 1.0
      env: JL_PKG=CoalaBears
      install:
        - julia --color=yes .ci/deps.julia.jl
        - julia -e 'import Lint.lintfile'

    - stage: test-failing
      language: julia
      # default language is 0.6.4, and has problems with pre-installed Lint.jl
      # and `using` in .ci/deps.julia.jl also incompatible
      julia: 0.6.4
      env: JL_PKG=CoalaBears
      install:
        - julia --color=yes .ci/deps.julia.jl
        - julia -e 'import Lint.lintfile'

    - stage: test-travis-community-langs
      language: julia
      julia: 0.7.0
      env: JL_PKG=CoalaBears
      install:
        - julia --color=yes .ci/deps.julia.jl
        - julia -e 'import Lint.lintfile'

    - language: r
      r: devel
    - language: r
      r: release
    - language: r
      # default version is 3.6.0, and it doesnt do DESCRIPTION?
      r: oldrel

    # coala hacks for extra languages
    - stage: test-manual-langs

      language: lua
      env: BEARS=lua
      addons:
        apt:
          packages:
            - luarocks

    - language: generic
      env: BEARS=opam INFER_VERSION=0.7.0
           PATH=$PATH:$HOME/infer-linux64-v$INFER_VERSION/infer/bin
      addons:
        apt:
          sources:
            - avsm
          packages:
            - camlp4-extra
            - ocaml
            - opam

    - stage: test-failing
      language: generic
      env: BEARS=infer INFER_VERSION=0.16.0 TODO=fixtests

    - stage: test-failing
      language: generic
      ghc: 8.0.2
      env: TODO=update-apt-versions
      dist: precise
      addons:
        apt:
          sources:
            - deadsnakes
            - hvr-ghc
          packages:
            - cabal-install-1.24
            - ghc-8.0.2
            - happy-1.19.3
            - python3.4

    # language: haskell
    # ghc: "7.10"
    # language: haskell
    # ghc: 7.8
    # language: haskell
    # ghc: 7.6
    # language: haskell
    # ghc: 8.0.2
    # language: haskell
    # ghc: 8.4.1

    - language: dart
      dart: stable

    # This is in manual languages, as language: haskell isnt working yet
    - stage: test-manual-langs
      language: generic
      dist: xenial
      env: DIST=xenial BEARS=adhoc BEAR_LIST="ghc-mod hlint"
      # ghc-mod needs parts of ghc, specifically at least /usr/lib/ghc/settings
      # ghc-mod needs cabal-install
      # shellcheck is failing in xenial; new features probably
      addons:
        apt:
          packages:
            - cabal-install
            - ghc
            - ghc-mod
            - hlint

    # BEARS=apt_get rather than 'apt' to avoid invoking .deps.apt.sh
    # which is the old circle init
    - stage: test-apt
      language: generic
      dist: xenial
      env: DIST=xenial BEARS=apt_get DISABLE_BEARS=shellcheck
      addons:
        apt:
          packages:
            - chktex
            - cppcheck
            - devscripts
            - flawfinder
            - indent
            - libperl-critic-perl
            - libxml2-utils
            - mono-mcs
            - php7.0-cli
            - phpmd
            - php-codesniffer
            - verilator

    - stage: test-apt
      language: generic
      dist: xenial
      env: DIST=xenial BEARS=adhoc BEAR_LIST="bakalint default-jre go"
      # ruby will match rubocop which isnt available for xenial

      # php will pick language, and pre-install php-codesniffer
      # maybe can disable in deps.php.sh
      # better is move lang php to composer
      addons:
        apt:
          packages:
            - chktex
            - cppcheck
            - devscripts
            - flawfinder
            - indent
            - libperl-critic-perl
            - libxml2-utils
            - mono-mcs
            - php7.0-cli
            - phpmd
            - php-codesniffer
            - verilator

    - stage: test-apt
      language: generic
      env: DIST=trusty BEARS=apt_get
      addons:
        apt:
          sources:
            - sourceline:  # astyle
                deb http://ppa.launchpad.net/cs50/ppa/ubuntu trusty main
              key_url:
                https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x5BDA2E974A0E822C
          packages:
            - astyle
            - chktex
            - cppcheck
            - devscripts
            - flawfinder
            - indent
            - libperl-critic-perl
            - libxml2-utils
            - mono-mcs
            - php5-cli
            - php-codesniffer
            - shellcheck
            - verilator

    - stage: test-apt
      language: generic
      env: DIST=precise BEARS=apt_get
      dist: precise
      addons:
        apt:
          packages:
            - chktex
            - cppcheck
            - devscripts
            - flawfinder
            - indent
            - libperl-critic-perl
            - libxml2-utils
            - mono-mcs
            - php5-cli
            - python3
            - verilator

    - stage: test-failing
      language: generic
      env: DIST=xenial BEARS=apt_get TODO=fix-shellcheck,debug-formatr
      dist: xenial
      addons:
        apt:
          packages:
            - astyle
            - r-cran-codetools
            - r-cran-formatr
            - shellcheck

    - stage: test-failing
      language: generic
      env: DIST=trusty BEARS=apt_get
           TODO=disable-shellcheck,debug-formatr
           DISABLE_BEARS=shellcheck
      dist: trusty
      # hlint bear depends on --json, which isnt in trusty hlint
      addons:
        apt:
          packages:
            - hlint
            - shellcheck

    - stage: test-failing
      language: generic
      env: DIST=trusty BEARS=adhoc BEAR_LIST="goreturns"
      dist: trusty

    - stage: test-failing
      language: generic
      env: DIST=precise BEARS=adhoc BEAR_LIST="go phpcs"
      dist: precise
      addons:
        apt:
          packages:
            - php-codesniffer
            - shellcheck

    - *check_moban
  allow_failures:
    - *check_moban

.cache:
  pip: true
  directories:
    - docs/_build
    # Installed language package caches
    - ~/.cabal
    - ~/.ghc
    - ~/.ghc-mod
    - ~/R/Library
    - ~/.julia
    - ~/.luarocks
    - $TRAVIS_BUILD_DIR/node_modules
    - $TRAVIS_BUILD_DIR/.bundle
    - $TRAVIS_BUILD_DIR/vendor
    # coala managed data
    - ~/nltk_data
    # Installed linters
    # Check this version works
    - ~/infer-linux64-v$INFER_VERSION
    - ~/.local/

env:
  global:
    - TERM=dumb
    - R_LIB_USER=~/R/Library
    - LINTR_COMMENT_BOT=false
    - CABAL_VERSION=1.24
    - PATH="$HOME/.nuget/packages/fudge/1.3.0/tools:$HOME/.local/bin:/opt/cabal/$CABAL_VERSION/bin:$PATH:$TRAVIS_BUILD_DIR/node_modules/.bin:$TRAVIS_BUILD_DIR/vendor/bin:$HOME/.cabal/bin:$HOME/.local/tailor/tailor-latest/bin:$HOME/.luarocks/bin"
    # These are only needed by Windows
    - NUGET_EXE_NO_PROMPT=true
    - VIRTUALENV_NO_DOWNLOAD=1
    - VIRTUALENV_NO_PIP=1
    - VIRTUALENV_NO_SETUPTOOLS=1
    - VIRTUALENV_VERBOSE=1
    - PIP_DISABLE_PIP_VERSION_CHECK=1
    - PIP_YES=1
    - FudgeCI=${TRAVIS_BUILD_DIR}/.ci/
    - TOX_FEATURES=check-noskip-codecov

before_install:
  - printenv
  - mkdir -p ~/bin ~/.local/bin

  - if [ -z "$GOPATH" ]; then
      export GOPATH="/home/travis/gopath";
    fi

  # echo $TRAVIS_LANGUAGE
  # TODO: implement DISABLE_BEARS globally, esp deps.generic.sh

  - if [ -f .ci/deps.$TRAVIS_LANGUAGE.sh ]; then
      bash -e -x .ci/deps.$TRAVIS_LANGUAGE.sh;
    fi

  - python --version
  # ~/bin is uncached; ~/local/bin is cached; we dont want python/pip in latter
  - rm -f ~/.local/bin/python* ~/.local/bin/pip*

  - source .ci/deps.pyenv.sh
  - pyenv versions
  - pyenv versions --bare
  # node-gpy needs py27
  - if [ "$TRAVIS_LANGUAGE" = "node_js" ]; then pyenv global 2.7; hash -r; fi
  - if [ "$BEARS" = "infer" ]; then pyenv global 2.7; hash -r; fi
  - pyenv versions
  - python --version

  # Remove Ruby directive from Gemfile as this image has 2.2.5
  - sed -i.bak '/^ruby/d' Gemfile

  # Used by go, to do nothing; not working
  - if [ -f .ci/$TRAVIS_LANGUAGE.GNUMakefile ]; then
      ln -s .ci/$TRAVIS_LANGUAGE.GNUMakefile ./GNUMakefile;
    fi
  # https://github.com/coala/coala/issues/3183
  - cp requirements.txt requirements.orig
  - printf '%s\n%s\n%s\n%s\n%s\n%s\n%s\n'
           "tox-travis" "tox-backticks" "tox-pyenv" "tox-venv"
           "$(cat test-requirements.txt)"
           "$(grep -v '^-r' docs-requirements.txt)"
           "$(cat bear-requirements.txt requirements.txt)"
           > requirements.txt
  - ls -al requirements.txt GNUMakefile || true

before_script:
  - source .ci/deps.python36.sh
  - hash -r
  - pyenv versions
  - python --version
  - mv requirements.orig requirements.txt

script:
  - echo "SCRIPT HERE"
  # python setup.py bdist_wheel
  # pip install $(ls ./dist/*.whl)"[alldeps]"
  # coala --non-interactive
  - if [ -z "$TRAVIS_PYTHON_VERSION" ]; then
      pyenv global $(pyenv versions --bare | fgrep '3.6' --max-count 1)
                   $(pyenv versions --bare | fgrep '2.7' --max-count 1);
      hash -r;
    fi
  - python --version
  # Ensure metadata files are in sync with the bear metadata in the source
  - if [ -n "$TRAVIS_PYTHON_VERSION" ]; then
      PYTHONPATH=. .ci/generate_bear_metadata.py --debug --update;
      git diff;
    fi
  - if [ -z "$TRAVIS_PYTHON_VERSION" ]; then
      python -m pip install --upgrade --user
        tox-travis tox-backticks tox-pyenv tox-venv;
    fi
  - python -m tox
  # python setup.py docs

notifications:
  email: false

branches:
  exclude:
    - /^sils\//
